<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TwitchLaser Control</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #0e0e10; color: #efeff1; padding: 20px; }
        h1 { text-align: center; font-size: 1.6rem; margin-bottom: 20px; color: #9147ff; letter-spacing: 1px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; max-width: 1400px; margin: 0 auto; }
        .full-width { grid-column: 1 / -1; }

        .card { background: #18181b; border: 1px solid #2d2d35; border-radius: 10px; padding: 18px; }
        .card h3 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: #9147ff; margin-bottom: 14px; border-bottom: 1px solid #2d2d35; padding-bottom: 8px; }

        .status-row { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
        .status-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #464649; flex-shrink: 0; }
        .dot.on   { background: #00c853; box-shadow: 0 0 6px #00c853; }
        .dot.warn { background: #ffa000; box-shadow: 0 0 6px #ffa000; }

        button { background: #9147ff; color: #fff; border: none; border-radius: 6px; padding: 8px 14px; cursor: pointer; font-size: 0.85rem; transition: background 0.15s; }
        button:hover         { background: #772ce8; }
        button.danger        { background: #b91c1c; }
        button.danger:hover  { background: #991b1b; }
        button.secondary     { background: #3a3a43; }
        button.secondary:hover { background: #464650; }
        button.success       { background: #00875a; }
        button.success:hover { background: #006644; }
        button.warn          { background: #92400e; }
        button.warn:hover    { background: #78350f; }

        .btn-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }

        input[type="text"], input[type="number"], select {
            background: #0e0e10; border: 1px solid #3a3a43; border-radius: 6px;
            color: #efeff1; padding: 7px 10px; font-size: 0.85rem; width: 100%;
        }
        input:focus, select:focus { outline: none; border-color: #9147ff; }

        label { font-size: 0.8rem; color: #adadb8; display: block; margin-bottom: 4px; margin-top: 10px; }
        label:first-child { margin-top: 0; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 14px; }

        #layout-canvas { border: 1px solid #3a3a43; border-radius: 6px; background: #111; cursor: crosshair; max-width: 100%; }
        #canvas-tooltip { position: absolute; background: #18181b; border: 1px solid #9147ff; border-radius: 5px; padding: 4px 8px; font-size: 0.78rem; pointer-events: none; display: none; white-space: nowrap; z-index: 10; }
        #canvas-legend { font-size: 0.78rem; color: #adadb8; line-height: 2; }
        .legend-swatch { display: inline-block; width: 12px; height: 12px; border-radius: 2px; margin-right: 5px; vertical-align: middle; }

        #log { font-family: monospace; font-size: 0.78rem; color: #adadb8; background: #0e0e10; border: 1px solid #2d2d35; border-radius: 6px; padding: 10px; max-height: 160px; overflow-y: auto; line-height: 1.6; }

        .badge { display: inline-block; background: #2d2d35; border-radius: 4px; padding: 2px 8px; font-size: 0.78rem; font-family: monospace; }
        #queue-list { font-size: 0.82rem; color: #adadb8; line-height: 2; }
        .save-ok { color: #00c853; font-size: 0.8rem; margin-left: 8px; display: none; }

        .danger-zone { border: 1px solid #7f1d1d; border-radius: 8px; padding: 14px; margin-top: 10px; }
        .danger-zone p { font-size: 0.78rem; color: #fca5a5; margin-bottom: 10px; }
        .danger-zone .btn-row { margin-top: 0; }

        #visualizer-wrap { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; position: relative; }

        .coord-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-top: 8px; }
        .coord-row label { margin-top: 0; }
        .hint { font-size: 0.75rem; color: #6b6b78; margin-top: 4px; }
    </style>
</head>
<body>

<h1>&#128308; TwitchLaser Control</h1>

<div class="grid">

    <!-- STATUS -->
    <div class="card">
        <h3>System Status</h3>
        <div class="status-row">
            <div class="status-item"><span class="dot" id="dot-laser"></span> Laser</div>
            <div class="status-item"><span class="dot" id="dot-twitch"></span> Twitch</div>
            <div class="status-item"><span class="dot" id="dot-camera"></span> Camera</div>
        </div>
        <div style="margin-top:12px; display:flex; gap:16px; flex-wrap:wrap;">
            <span>Queue: <span class="badge" id="stat-queue">0</span></span>
            <span>Names: <span class="badge" id="stat-names">0</span></span>
            <span>Coverage: <span class="badge" id="stat-coverage">0%</span></span>
        </div>
    </div>

    <!-- LASER CONTROLS -->
    <div class="card">
        <h3>Laser Controls</h3>
        <div class="btn-row">
            <button onclick="laserCmd('home')">&#127968; Home</button>
            <button class="secondary" onclick="laserCmd('unlock')">&#128275; Unlock</button>
            <button class="danger" onclick="laserCmd('stop')">&#9940; E-Stop</button>
        </div>
        <div class="btn-row">
            <button class="secondary" onclick="toggleTwitch()" id="btn-twitch">&#9654; Start Twitch</button>
            <button class="secondary" onclick="reconnectLaser()" id="btn-laser-reconnect">&#128279; Reconnect Laser</button>
            <button class="secondary" onclick="reconnectTwitch()" id="btn-twitch-reconnect">&#128279; Reconnect Twitch</button>
        </div>
        <label style="margin-top:14px;">Manual G-code</label>
        <div style="display:flex; gap:6px;">
            <input type="text" id="manual-cmd" placeholder="e.g. G0 X10 Y10" onkeydown="if(event.key==='Enter')sendManual()">
            <button onclick="sendManual()" style="white-space:nowrap">Send</button>
        </div>
    </div>

    <!-- TEST ENGRAVE -->
    <div class="card">
        <h3>Test Engrave</h3>
        <label>Text to engrave</label>
        <input type="text" id="test-text" placeholder="e.g. TestUser" maxlength="24">
        <label style="margin-top:10px;">Override position <span style="color:#6b6b78; font-weight:normal;">(optional &mdash; leave blank for auto-place)</span></label>
        <div class="coord-row">
            <div><label>X1 (mm)</label><input type="number" id="te-x1" placeholder="auto" step="0.1"></div>
            <div><label>Y1 (mm)</label><input type="number" id="te-y1" placeholder="auto" step="0.1"></div>
            <div><label>X2 (mm)</label><input type="number" id="te-x2" placeholder="auto" step="0.1"></div>
            <div><label>Y2 (mm)</label><input type="number" id="te-y2" placeholder="auto" step="0.1"></div>
        </div>
        <p class="hint">Machine coordinates of the rectangle to engrave into. All four required to use override.</p>
        <div class="btn-row" style="margin-top:10px;">
            <button class="success" onclick="testEngrave()">&#9654; Engrave Now</button>
        </div>
        <div id="engrave-result" style="margin-top:8px; font-size:0.8rem; color:#adadb8;"></div>
    </div>

    <!-- MANUAL PLACEMENT -->
    <div class="card">
        <h3>Add Manual Placement</h3>
        <p style="font-size:0.78rem; color:#adadb8; margin-bottom:8px;">Block out a region in the database without engraving &mdash; use this when a name is already on the board but not tracked.</p>
        <label>Name / label</label>
        <input type="text" id="mp-name" placeholder="e.g. ExistingName" maxlength="40">
        <label style="margin-top:10px;">Rectangle (machine coordinates)</label>
        <div class="coord-row">
            <div><label>X1 (mm)</label><input type="number" id="mp-x1" placeholder="0" step="0.1"></div>
            <div><label>Y1 (mm)</label><input type="number" id="mp-y1" placeholder="0" step="0.1"></div>
            <div><label>X2 (mm)</label><input type="number" id="mp-x2" placeholder="20" step="0.1"></div>
            <div><label>Y2 (mm)</label><input type="number" id="mp-y2" placeholder="8" step="0.1"></div>
        </div>
        <div class="btn-row">
            <button onclick="addManualPlacement()">&#43; Add to Database</button>
        </div>
        <div id="mp-result" style="margin-top:8px; font-size:0.8rem; color:#adadb8;"></div>
    </div>

    <!-- LASER SETTINGS -->
    <div class="card">
        <h3>Laser Settings</h3>
        <div class="form-grid">
            <div>
                <label>Power (%)</label>
                <input type="number" id="s-power" min="0" max="100" step="1" value="50">
            </div>
            <div>
                <label>Spindle Max (S)</label>
                <input type="number" id="s-spindle-max" min="100" max="10000" step="100" value="1000">
            </div>
            <div>
                <label>Speed (mm/min)</label>
                <input type="number" id="s-speed" min="100" max="10000" step="100" value="1000">
            </div>
            <div>
                <label>Passes</label>
                <input type="number" id="s-passes" min="1" max="5" step="1" value="1">
            </div>
        </div>
        <div class="btn-row">
            <button onclick="saveLaserSettings()">&#128190; Save Settings</button>
            <span class="save-ok" id="laser-ok">&#10003; Saved</span>
        </div>
    </div>

    <!-- TEXT / FONT SETTINGS -->
    <div class="card">
        <h3>Text &amp; Font Settings</h3>
        <div class="form-grid">
            <div>
                <label>Initial Height (mm)</label>
                <input type="number" id="s-height" min="2" max="50" step="0.5" value="5">
            </div>
            <div>
                <label>Min Height (mm)</label>
                <input type="number" id="s-min-height" min="1" max="20" step="0.5" value="2">
            </div>
            <div style="grid-column:1/-1">
                <label>Font</label>
                <select id="s-font">
                    <option value="simplex">Simplex &#8211; thin</option>
                    <option value="medium">Simplex &#8211; medium</option>
                    <option value="bold">Simplex &#8211; bold</option>
                    <option value="heavy">Simplex &#8211; heavy</option>
                    <option value="hershey_roman">Hershey Roman (serif)</option>
                    <option value="hershey_script">Hershey Script (cursive)</option>
                    <option value="hershey_gothic">Hershey Gothic</option>
                    <option value="ttf">TrueType font</option>
                    <option value="ttf_bold">TrueType font &#8211; bold</option>
                </select>
            </div>
            <div style="grid-column:1/-1">
                <label>TTF Font Path (required for TrueType options)</label>
                <input type="text" id="s-ttf-path" placeholder="/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf">
            </div>
        </div>
        <div class="btn-row">
            <button onclick="saveTextSettings()">&#128190; Save</button>
            <span class="save-ok" id="text-ok">&#10003; Saved</span>
        </div>
    </div>

    <!-- WORK AREA -->
    <div class="card">
        <h3>Work Area</h3>
        <p style="font-size:0.78rem; color:#adadb8; margin-bottom:8px;">
            Machine bed = full travel range. Active = engraving region. Offset = top-left of active region in machine space.
        </p>
        <div class="form-grid">
            <div>
                <label>Machine Width (mm)</label>
                <input type="number" id="wa-mw" min="1" max="2000" step="1" value="200">
            </div>
            <div>
                <label>Machine Height (mm)</label>
                <input type="number" id="wa-mh" min="1" max="2000" step="1" value="298">
            </div>
            <div>
                <label>Active Width (mm)</label>
                <input type="number" id="wa-aw" min="1" max="2000" step="1" value="200">
            </div>
            <div>
                <label>Active Height (mm)</label>
                <input type="number" id="wa-ah" min="1" max="2000" step="1" value="298">
            </div>
            <div>
                <label>Offset X (mm)</label>
                <input type="number" id="wa-ox" min="0" max="2000" step="1" value="0">
            </div>
            <div>
                <label>Offset Y (mm)</label>
                <input type="number" id="wa-oy" min="0" max="2000" step="1" value="0">
            </div>
        </div>
        <div class="btn-row">
            <button onclick="saveWorkArea()">&#128190; Apply</button>
            <span class="save-ok" id="wa-ok">&#10003; Applied</span>
        </div>
    </div>

    <!-- QUEUE -->
    <div class="card">
        <h3>Engraving Queue <span class="badge" id="queue-badge">0</span></h3>
        <div id="queue-list">Queue is empty</div>
    </div>

    <!-- DANGER ZONE -->
    <div class="card">
        <h3>&#9888;&#65039; System Controls</h3>
        <div class="danger-zone">
            <p>Irreversible or disruptive actions. You must type a confirmation word when prompted.</p>
            <div class="btn-row">
                <button class="danger" onclick="resetBoard()">&#128465; Reset Board</button>
                <button class="warn"   onclick="restartService()">&#128260; Restart Service</button>
            </div>
        </div>
    </div>

    <!-- LOG -->
    <div class="card full-width">
        <h3>Activity Log</h3>
        <div id="log"></div>
    </div>

    <!-- VISUALIZER -->
    <div class="card full-width">
        <h3>Layout Visualizer</h3>
        <div id="visualizer-wrap">
            <div style="position:relative;">
                <canvas id="layout-canvas" width="720" height="520"></canvas>
                <div id="canvas-tooltip"></div>
            </div>
            <div id="canvas-legend">
                <div><span class="legend-swatch" style="background:#1a1a1a; border:1px solid #555;"></span> Machine bed</div>
                <div><span class="legend-swatch" style="background:rgba(145,71,255,0.12); border:1px dashed #9147ff;"></span> Active engraving area</div>
                <div><span class="legend-swatch" style="background:rgba(0,180,100,0.45);"></span> Engraved name</div>
                <div style="margin-top:12px; color:#efeff1; font-size:0.8rem; line-height:1.9;" id="vis-info">Loading...</div>
            </div>
        </div>
    </div>

</div>

<script>
function log(msg, color) {
    color = color || '#adadb8';
    var el = document.getElementById('log');
    var ts = new Date().toLocaleTimeString();
    el.innerHTML += '<div style="color:' + color + '">[' + ts + '] ' + msg + '</div>';
    el.scrollTop = el.scrollHeight;
}

async function api(path, method, body) {
    method = method || 'GET';
    var opts = { method: method, headers: {'Content-Type':'application/json'} };
    if (body) opts.body = JSON.stringify(body);
    var r = await fetch(path, opts);
    return r.json();
}

// STATUS
async function updateStatus() {
    try {
        var s = await api('/api/status');
        setDot('dot-laser',  s.laser_connected);
        setDot('dot-twitch', s.twitch_running);
        setDot('dot-camera', s.camera_running);
        document.getElementById('stat-queue').textContent    = s.queue_size;
        document.getElementById('stat-names').textContent    = s.placements;
        document.getElementById('stat-coverage').textContent = s.coverage + '%';
        document.getElementById('btn-twitch').textContent    = s.twitch_running ? '&#9646;&#9646; Stop Twitch' : '&#9654; Start Twitch';

        if (!window._settingsLoaded && s.config) {
            var ls = s.config.laser_settings || {};
            var ts = s.config.text_settings  || {};
            setVal('s-power',      ls.power_percent    || 50);
            setVal('s-spindle-max',ls.spindle_max       || 1000);
            setVal('s-speed',      ls.speed_mm_per_min  || 1000);
            setVal('s-passes',     ls.passes            || 1);
            setVal('s-height',     ts.initial_height_mm || 5);
            setVal('s-min-height', ts.min_height_mm     || 2);
            if (ts.font)     setVal('s-font',     ts.font);
            if (ts.ttf_path) setVal('s-ttf-path', ts.ttf_path);
            window._settingsLoaded = true;
        }
    } catch(e) {}
}

function setDot(id, on) { document.getElementById(id).className = 'dot' + (on ? ' on' : ''); }
function setVal(id, v)  { var el = document.getElementById(id); if (el) el.value = v; }

// FONT DROPDOWN
async function loadFonts() {
    try {
        var fonts = await api('/api/fonts');
        var sel   = document.getElementById('s-font');
        sel.innerHTML = '';
        fonts.forEach(function(f) {
            var opt = document.createElement('option');
            opt.value       = f.key;
            opt.textContent = f.label;
            sel.appendChild(opt);
        });
    } catch(e) { /* keep hardcoded options */ }
}

// LASER CONTROLS
async function laserCmd(action) {
    var ep = {home:'/api/laser_home', unlock:'/api/laser_unlock', stop:'/api/laser_stop'};
    var r  = await api(ep[action], 'POST');
    log(action + ': ' + (r.message || (r.success ? 'OK' : 'Failed')), r.success ? '#00c853' : '#e91916');
}

async function sendManual() {
    var cmd = document.getElementById('manual-cmd').value.trim();
    if (!cmd) return;
    var r = await api('/api/laser_command', 'POST', {command: cmd});
    log('> ' + cmd + '  ->  ' + (r.response || ''), r.success ? '#efeff1' : '#e91916');
    document.getElementById('manual-cmd').value = '';
}

async function toggleTwitch() {
    var r = await api('/api/twitch_toggle', 'POST');
    log('Twitch ' + (r.running ? 'started' : 'stopped'), r.running ? '#00c853' : '#adadb8');
}

async function reconnectLaser() {
    log('Reconnecting laser...', '#ffa000');
    var r = await api('/api/laser_reconnect', 'POST');
    log('Laser: ' + r.message, r.success ? '#00c853' : '#e91916');
}

async function reconnectTwitch() {
    log('Reconnecting Twitch...', '#ffa000');
    var r = await api('/api/twitch_reconnect', 'POST');
    log('Twitch: ' + r.message, r.success ? '#00c853' : '#e91916');
}

// TEST ENGRAVE
async function testEngrave() {
    var text = document.getElementById('test-text').value.trim();
    if (!text) return;

    var x1 = document.getElementById('te-x1').value;
    var y1 = document.getElementById('te-y1').value;
    var x2 = document.getElementById('te-x2').value;
    var y2 = document.getElementById('te-y2').value;

    var body = { text: text };
    // Only send rect if ALL four coords are filled in
    if (x1 !== '' && y1 !== '' && x2 !== '' && y2 !== '') {
        body.rect = { x1: parseFloat(x1), y1: parseFloat(y1),
                      x2: parseFloat(x2), y2: parseFloat(y2) };
    }

    var r  = await api('/api/test_engrave', 'POST', body);
    var el = document.getElementById('engrave-result');
    el.textContent = r.message;
    el.style.color = r.success ? '#00c853' : '#e91916';
    log('Engrave "' + text + '": ' + r.message, r.success ? '#00c853' : '#e91916');
    if (r.success) drawVisualizer();
}

// MANUAL PLACEMENT
async function addManualPlacement() {
    var name = document.getElementById('mp-name').value.trim();
    var x1   = document.getElementById('mp-x1').value;
    var y1   = document.getElementById('mp-y1').value;
    var x2   = document.getElementById('mp-x2').value;
    var y2   = document.getElementById('mp-y2').value;

    if (!name) { alert('Please enter a name.'); return; }
    if (x1===''||y1===''||x2===''||y2==='') { alert('Please fill in all four coordinates.'); return; }

    var r  = await api('/api/add_placement', 'POST', {
        name: name,
        x1: parseFloat(x1), y1: parseFloat(y1),
        x2: parseFloat(x2), y2: parseFloat(y2)
    });
    var el = document.getElementById('mp-result');
    el.textContent = r.message;
    el.style.color = r.success ? '#00c853' : '#e91916';
    log('Manual placement "' + name + '": ' + r.message, r.success ? '#00c853' : '#e91916');
    if (r.success) {
        document.getElementById('mp-name').value = '';
        document.getElementById('mp-x1').value   = '';
        document.getElementById('mp-y1').value   = '';
        document.getElementById('mp-x2').value   = '';
        document.getElementById('mp-y2').value   = '';
        drawVisualizer();
    }
}

// LASER SETTINGS
async function saveLaserSettings() {
    var body = {
        laser_settings: {
            power_percent:    +document.getElementById('s-power').value,
            spindle_max:      +document.getElementById('s-spindle-max').value,
            speed_mm_per_min: +document.getElementById('s-speed').value,
            passes:           +document.getElementById('s-passes').value
        }
    };
    await api('/api/config', 'POST', body);
    flashOk('laser-ok');
    log('Laser settings saved', '#00c853');
}

// TEXT / FONT SETTINGS
async function saveTextSettings() {
    var font    = document.getElementById('s-font').value;
    var ttfPath = document.getElementById('s-ttf-path').value.trim();
    var body = { text_settings: {
        initial_height_mm: parseFloat(document.getElementById('s-height').value),
        min_height_mm:     parseFloat(document.getElementById('s-min-height').value),
        font:     font,
        ttf_path: ttfPath || null
    }};
    await api('/api/config', 'POST', body);
    flashOk('text-ok');
    log('Text settings saved â€” font: ' + font, '#00c853');
}

// WORK AREA
async function loadWorkArea() {
    var d = await api('/api/work_area');
    if (d.machine) { setVal('wa-mw', d.machine.width_mm);  setVal('wa-mh', d.machine.height_mm); }
    if (d.active)  { setVal('wa-aw', d.active.width_mm);   setVal('wa-ah', d.active.height_mm);
                     setVal('wa-ox', d.active.offset_x);   setVal('wa-oy', d.active.offset_y); }
    drawCanvas(d);
}

async function saveWorkArea() {
    var body = {
        machine_width_mm:  +document.getElementById('wa-mw').value,
        machine_height_mm: +document.getElementById('wa-mh').value,
        active_width_mm:   +document.getElementById('wa-aw').value,
        active_height_mm:  +document.getElementById('wa-ah').value,
        offset_x_mm:       +document.getElementById('wa-ox').value,
        offset_y_mm:       +document.getElementById('wa-oy').value
    };
    var r = await api('/api/work_area', 'POST', body);
    if (r.success) {
        flashOk('wa-ok');
        log('Work area applied: ' + body.active_width_mm + 'x' + body.active_height_mm +
            'mm offset (' + body.offset_x_mm + ',' + body.offset_y_mm + ')', '#00c853');
        drawVisualizer();
    } else {
        log('Work area error: ' + r.message, '#e91916');
    }
}

// DANGER ZONE
async function resetBoard() {
    var input = prompt('This will archive the current board and start fresh.\n\nType RESET to confirm:');
    if (input !== 'RESET') { log('Reset cancelled.', '#adadb8'); return; }
    var r = await api('/api/reset_board', 'POST');
    log(r.message, r.success ? '#ffa000' : '#e91916');
    if (r.success) drawVisualizer();
}

async function restartService() {
    var input = prompt('The service will restart. Page reloads in 8 seconds.\n\nType RESTART to confirm:');
    if (input !== 'RESTART') { log('Restart cancelled.', '#adadb8'); return; }
    log('Service restarting... reloading in 8s', '#ffa000');
    await api('/api/restart_service', 'POST');
    setTimeout(function() { location.reload(); }, 8000);
}

// QUEUE
async function updateQueue() {
    var d  = await api('/api/queue');
    var el = document.getElementById('queue-list');
    var bk = document.getElementById('queue-badge');
    if (d.queue && d.queue.length > 0) {
        bk.textContent = d.queue.length;
        el.innerHTML   = d.queue.map(function(j, i) {
            return '<div>' + (i+1) + '. <strong>' + j.name + '</strong> ' +
                   '<span style="color:#adadb8;font-size:0.75rem">(' + j.source + ')</span></div>';
        }).join('');
    } else {
        bk.textContent = '0';
        el.textContent = 'Queue is empty';
    }
}

// VISUALIZER
async function drawVisualizer() {
    var d = await api('/api/work_area');
    drawCanvas(d);
}

function drawCanvas(d) {
    if (!d || !d.machine || !d.machine.width_mm) return;

    var canvas = document.getElementById('layout-canvas');
    var ctx    = canvas.getContext('2d');
    var PAD    = 24;
    var mw     = d.machine.width_mm;
    var mh     = d.machine.height_mm;
    var scale  = Math.min((canvas.width - PAD*2) / mw, (canvas.height - PAD*2) / mh);

    canvas._scale = scale; canvas._pad = PAD; canvas._data = d;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Machine bed
    ctx.fillStyle = '#1a1a1a'; ctx.fillRect(PAD, PAD, mw*scale, mh*scale);
    ctx.strokeStyle = '#555';  ctx.lineWidth = 1;
    ctx.strokeRect(PAD, PAD, mw*scale, mh*scale);

    // 50mm grid
    ctx.strokeStyle = '#252525'; ctx.lineWidth = 0.5;
    for (var gx=50; gx<mw; gx+=50) { var gpx=PAD+gx*scale; ctx.beginPath(); ctx.moveTo(gpx,PAD); ctx.lineTo(gpx,PAD+mh*scale); ctx.stroke(); }
    for (var gy=50; gy<mh; gy+=50) { var gpy=PAD+gy*scale; ctx.beginPath(); ctx.moveTo(PAD,gpy); ctx.lineTo(PAD+mw*scale,gpy); ctx.stroke(); }

    // Active area
    if (d.active && d.active.width_mm) {
        var ax=PAD+d.active.offset_x*scale, ay=PAD+d.active.offset_y*scale;
        var aw=d.active.width_mm*scale,     ah=d.active.height_mm*scale;
        ctx.fillStyle='rgba(145,71,255,0.07)'; ctx.fillRect(ax,ay,aw,ah);
        ctx.strokeStyle='#9147ff'; ctx.lineWidth=1.5;
        ctx.setLineDash([7,3]); ctx.strokeRect(ax,ay,aw,ah); ctx.setLineDash([]);
        ctx.fillStyle='#9147ff'; ctx.font='10px sans-serif';
        ctx.fillText('Active ' + d.active.width_mm + 'x' + d.active.height_mm +
                     'mm  offset (' + d.active.offset_x + ',' + d.active.offset_y + ')', ax+4, ay+13);
    }

    // Placements
    var ox = d.active ? d.active.offset_x : 0;
    var oy = d.active ? d.active.offset_y : 0;
    (d.placements || []).forEach(function(p) {
        var px = PAD + (p.abs_x !== undefined ? p.abs_x : p.x + ox) * scale;
        var py = PAD + (p.abs_y !== undefined ? p.abs_y : p.y + oy) * scale;
        var pw = p.width * scale, ph = p.height * scale;
        ctx.fillStyle='rgba(0,180,100,0.35)'; ctx.fillRect(px,py,pw,ph);
        ctx.strokeStyle='#00b464'; ctx.lineWidth=0.8; ctx.strokeRect(px,py,pw,ph);
        if (pw > 18) {
            ctx.fillStyle='#efeff1';
            ctx.font = Math.min(9, ph * 0.7) + 'px sans-serif';
            ctx.save(); ctx.beginPath(); ctx.rect(px,py,pw,ph); ctx.clip();
            ctx.fillText(p.name, px+2, py+ph*0.72); ctx.restore();
        }
    });

    // Origin dot
    ctx.fillStyle='#ffa000'; ctx.beginPath(); ctx.arc(PAD,PAD,4,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#ffa000'; ctx.font='9px sans-serif'; ctx.fillText('0,0',PAD+6,PAD+4);

    // Edge labels
    ctx.fillStyle='#555'; ctx.font='8px sans-serif';
    ctx.fillText(mw+'mm', PAD+mw*scale-22, PAD+mh*scale+14);
    ctx.fillText(mh+'mm', 2, PAD+mh*scale);

    var pl = (d.placements || []).length;
    document.getElementById('vis-info').innerHTML =
        '<b>' + pl + '</b> name' + (pl!==1?'s':'') + ' engraved<br>' +
        'Machine: ' + mw + 'x' + mh + 'mm<br>' +
        'Active: ' + (d.active?d.active.width_mm:mw) + 'x' + (d.active?d.active.height_mm:mh) + 'mm<br>' +
        'Offset: (' + (d.active?d.active.offset_x:0) + ', ' + (d.active?d.active.offset_y:0) + ')mm';
}

// Tooltip
document.getElementById('layout-canvas').addEventListener('mousemove', function(e) {
    var d=this._data; if(!d||!d.placements) return;
    var rect=this.getBoundingClientRect(), mx=e.clientX-rect.left, my=e.clientY-rect.top;
    var scale=this._scale, pad=this._pad;
    var ox=d.active?d.active.offset_x:0, oy=d.active?d.active.offset_y:0;
    var tip=document.getElementById('canvas-tooltip');
    var found=null;
    (d.placements||[]).forEach(function(p) {
        var px=pad+(p.abs_x!==undefined?p.abs_x:p.x+ox)*scale;
        var py=pad+(p.abs_y!==undefined?p.abs_y:p.y+oy)*scale;
        if(mx>=px&&mx<=px+p.width*scale&&my>=py&&my<=py+p.height*scale) found=p;
    });
    if(found){
        tip.style.display='block'; tip.style.left=(mx+14)+'px'; tip.style.top=(my-8)+'px';
        tip.textContent=found.name+'  '+found.width.toFixed(1)+'x'+found.height.toFixed(1)+
                        'mm  h='+found.text_height_mm.toFixed(1)+'mm';
    } else { tip.style.display='none'; }
});
document.getElementById('layout-canvas').addEventListener('mouseleave', function() {
    document.getElementById('canvas-tooltip').style.display='none';
});

function flashOk(id) { var el=document.getElementById(id); el.style.display='inline'; setTimeout(function(){el.style.display='none';},3000); }

// INIT
window.addEventListener('DOMContentLoaded', async function() {
    log('TwitchLaser UI loaded', '#9147ff');
    await loadFonts();
    await loadWorkArea();
    await updateStatus();
    await updateQueue();
    setInterval(updateStatus,  3000);
    setInterval(updateQueue,   4000);
    setInterval(drawVisualizer,12000);
});
</script>
</body>
</html>
