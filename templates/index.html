<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TwitchLaser Control</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #0e0e10; color: #efeff1; padding: 20px; }
        
        /* HEADER AND STATUS */
        .header-container { max-width: 1400px; margin: 0 auto 20px auto; background: #18181b; border: 1px solid #2d2d35; border-radius: 10px; padding: 16px 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px; }
        .header-title { font-size: 1.5rem; color: #9147ff; letter-spacing: 1px; font-weight: bold; margin: 0; display: flex; align-items: baseline; gap: 10px; }
        .version-badge { font-size: 0.8rem; color: #555560; font-weight: normal; font-family: monospace; }
        
        .status-row { display: flex; flex-wrap: wrap; gap: 16px; align-items: center; }
        .status-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #464649; flex-shrink: 0; }
        .dot.on   { background: #00c853; box-shadow: 0 0 6px #00c853; }
        .dot.warn { background: #ffa000; box-shadow: 0 0 6px #ffa000; }
        .badge { display: inline-block; background: #2d2d35; border-radius: 4px; padding: 2px 8px; font-size: 0.78rem; font-family: monospace; }
        .stat-group { display: flex; gap: 12px; border-left: 1px solid #3a3a43; padding-left: 16px; margin-left: 4px; }

        /* GRID LAYOUT */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; max-width: 1400px; margin: 0 auto; }
        .full-width { grid-column: 1 / -1; }
        
        @media (min-width: 768px) {
            .span-2 { grid-column: span 2; }
        }

        .card { background: #18181b; border: 1px solid #2d2d35; border-radius: 10px; padding: 18px; }
        .card h3 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: #9147ff; margin-bottom: 14px; border-bottom: 1px solid #2d2d35; padding-bottom: 8px; }

        button { background: #9147ff; color: #fff; border: none; border-radius: 6px; padding: 8px 14px; cursor: pointer; font-size: 0.85rem; transition: background 0.15s; }
        button:hover         { background: #772ce8; }
        button.danger        { background: #b91c1c; }
        button.danger:hover  { background: #991b1b; }
        button.secondary     { background: #3a3a43; }
        button.secondary:hover { background: #464650; }
        button.success       { background: #00875a; }
        button.success:hover { background: #006644; }
        button.warn          { background: #92400e; }
        button.warn:hover    { background: #78350f; }

        .btn-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }

        input[type="text"], input[type="number"], select, textarea {
            background: #0e0e10; border: 1px solid #3a3a43; border-radius: 6px;
            color: #efeff1; padding: 7px 10px; font-size: 0.85rem; width: 100%;
        }
        textarea { font-family: monospace; font-size: 0.78rem; resize: vertical; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #9147ff; }

        label { font-size: 0.8rem; color: #adadb8; display: block; margin-bottom: 4px; margin-top: 10px; }
        label:first-child { margin-top: 0; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 14px; }

        #layout-canvas { border: 1px solid #3a3a43; border-radius: 6px; background: #111; cursor: crosshair; max-width: 100%; }
        #canvas-tooltip { position: absolute; background: #18181b; border: 1px solid #9147ff; border-radius: 5px; padding: 4px 8px; font-size: 0.78rem; pointer-events: none; display: none; white-space: nowrap; z-index: 10; }
        #canvas-legend { font-size: 0.78rem; color: #adadb8; line-height: 2; }
        .legend-swatch { display: inline-block; width: 12px; height: 12px; border-radius: 2px; margin-right: 5px; vertical-align: middle; }

        #log { font-family: monospace; font-size: 0.78rem; color: #adadb8; background: #0e0e10; border: 1px solid #2d2d35; border-radius: 6px; padding: 10px; max-height: 160px; overflow-y: auto; line-height: 1.6; }

        .save-ok { color: #00c853; font-size: 0.8rem; margin-left: 8px; display: none; }

        .danger-zone { border: 1px solid #7f1d1d; border-radius: 8px; padding: 14px; margin-top: 10px; }
        .danger-zone p { font-size: 0.78rem; color: #fca5a5; margin-bottom: 10px; }
        .danger-zone .btn-row { margin-top: 0; }

        #visualizer-wrap { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; position: relative; }

        .coord-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-top: 8px; }
        .coord-row label { margin-top: 0; }
        .hint { font-size: 0.75rem; color: #6b6b78; margin-top: 4px; }

        .obs-action-group { background: #111; border: 1px solid #2d2d35; border-radius: 6px; padding: 12px; margin-top: 10px; }
        .obs-action-group h4 { font-size: 0.78rem; color: #adadb8; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* QUEUE AND HISTORY STYLES */
        #queue-container { max-height: 400px; overflow-y: auto; padding-right: 10px; }
        #queue-list { font-size: 0.82rem; color: #adadb8; }
        .queue-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #2d2d35; transition: background 0.15s; }
        .queue-item:hover { background: #1f1f23; }
        .queue-item:last-child { border-bottom: none; }
        .queue-item.finished { opacity: 0.6; }
        .queue-item.active { background: rgba(145,71,255,0.1); border-radius: 4px; padding: 8px; border-left: 3px solid #9147ff; }
        .queue-item.failed, .queue-item.stopped { border-left: 3px solid #b91c1c; padding-left: 8px; opacity: 0.8; }
        .queue-icon { margin-right: 10px; cursor: help; font-size: 1.1rem; }
        .queue-details { flex-grow: 1; }
        .queue-actions { display: flex; gap: 6px; }
        .queue-actions button { padding: 4px 8px; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; }
        
        .job-settings-tooltip { position: relative; display: inline-block; cursor: help; border-bottom: 1px dotted #adadb8; margin-left: 8px; font-size: 0.75rem; }
        .job-settings-tooltip .tooltiptext { 
            visibility: hidden; 
            width: 220px; 
            background-color: #1a1a1a; 
            color: #fff; 
            text-align: left; 
            border-radius: 6px; 
            padding: 10px; 
            position: absolute; 
            z-index: 9999; 
            top: 125%; /* Drop downward to prevent clipping */
            left: 50%; 
            margin-left: -110px; 
            opacity: 0; 
            transition: opacity 0.2s; 
            border: 1px solid #9147ff; 
            font-size: 0.75rem; 
            white-space: pre-wrap; 
            line-height: 1.5; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.8); 
        }
        .job-settings-tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .job-settings-tooltip .tooltiptext::after { 
            content: ""; 
            position: absolute; 
            bottom: 100%; 
            left: 50%; 
            margin-left: -5px; 
            border-width: 5px; 
            border-style: solid; 
            border-color: transparent transparent #9147ff transparent; 
        }
    </style>
</head>
<body>

<div class="header-container">
    <h1 class="header-title">
        &#128308; TwitchLaser Control
        <span class="version-badge">v203000</span>
    </h1>
    
    <div class="status-row">
        <div class="status-item"><span class="dot" id="dot-laser"></span> Laser</div>
        <div class="status-item"><span class="dot" id="dot-twitch"></span> Twitch</div>
        <div class="status-item"><span class="dot" id="dot-camera"></span> Camera</div>
        <div class="status-item"><span class="dot" id="dot-obs"></span> OBS</div>
        
        <div class="stat-group">
            <div class="status-item">Pending: <span class="badge" id="stat-queue">0</span></div>
            <div class="status-item">Names: <span class="badge" id="stat-names">0</span></div>
            <div class="status-item">Coverage: <span class="badge" id="stat-coverage">0%</span></div>
        </div>
    </div>
</div>

<div class="grid">

    <!-- LASER CONTROLS -->
    <div class="card">
        <h3>Laser Controls</h3>
        <div class="btn-row">
            <button onclick="laserCmd('home')">&#127968; Home</button>
            <button class="secondary" onclick="laserCmd('unlock')">&#128275; Unlock</button>
            <button class="danger" onclick="laserCmd('stop')">&#9940; E-Stop</button>
        </div>
        <div class="btn-row">
            <button class="secondary" onclick="toggleTwitch()" id="btn-twitch">&#9654; Start Twitch</button>
            <button class="secondary" onclick="reconnectLaser()">&#128279; Reconn. Laser</button>
            <button class="secondary" onclick="reconnectTwitch()">&#128279; Reconn. Twitch</button>
        </div>
        <label style="margin-top:14px;">Manual G-code</label>
        <div style="display:flex; gap:6px;">
            <input type="text" id="manual-cmd" placeholder="e.g. G0 X10 Y10" onkeydown="if(event.key==='Enter')sendManual()">
            <button onclick="sendManual()" style="white-space:nowrap">Send</button>
        </div>
    </div>

    <!-- TEST ENGRAVE -->
    <div class="card">
        <h3>Test Engrave</h3>
        <label>Text to engrave</label>
        <input type="text" id="test-text" placeholder="e.g. TestUser" maxlength="24">
        <label style="margin-top:10px;">Override position <span style="color:#6b6b78; font-weight:normal;">(optional)</span></label>
        <div class="coord-row">
            <div><label>X1</label><input type="number" id="te-x1" placeholder="auto" step="0.1"></div>
            <div><label>Y1</label><input type="number" id="te-y1" placeholder="auto" step="0.1"></div>
            <div><label>X2</label><input type="number" id="te-x2" placeholder="auto" step="0.1"></div>
            <div><label>Y2</label><input type="number" id="te-y2" placeholder="auto" step="0.1"></div>
        </div>
        <div class="btn-row" style="margin-top:10px;">
            <button class="success" onclick="testEngrave()">&#9654; Queue Test</button>
        </div>
        <div id="engrave-result" style="margin-top:8px; font-size:0.8rem; color:#adadb8;"></div>
    </div>

    <!-- LASER FOCUS TEST -->
    <div class="card span-2">
        <h3>Laser Focus Test</h3>
        <p style="font-size:0.78rem; color:#adadb8; margin-bottom:8px;">Engraves a straight line while linearly adjusting the Z-axis, with perpendicular tick marks every 1/5th of the length to help identify the sharpest focus point.</p>
        
        <div class="form-grid">
            <div>
                <label>Start X (mm)</label>
                <input type="number" id="ft-x1" placeholder="10" step="0.1">
            </div>
            <div>
                <label>Start Y (mm)</label>
                <input type="number" id="ft-y1" placeholder="10" step="0.1">
            </div>
            <div>
                <label>End X (mm)</label>
                <input type="number" id="ft-x2" placeholder="100" step="0.1">
            </div>
            <div>
                <label>End Y (mm)</label>
                <input type="number" id="ft-y2" placeholder="10" step="0.1">
            </div>
            <div>
                <label>Z Distance Change (mm)</label>
                <input type="number" id="ft-z" placeholder="5.0" step="0.1">
                <p class="hint">Positive moves Z up, negative moves Z down</p>
            </div>
            <div>
                <label>Number of Tick Marks</label>
                <input type="number" id="ft-ticks" value="5" min="1" max="20" step="1">
            </div>
            <div>
                <label>Speed (mm/min)</label>
                <input type="number" id="ft-speed" value="600" step="10">
            </div>
            <div>
                <label>Power (%)</label>
                <input type="number" id="ft-power" value="20" min="1" max="100" step="1">
            </div>
        </div>
        
        <div class="btn-row" style="margin-top:14px;">
            <button class="warn" onclick="startFocusTest()">&#9888;&#65039; Start Focus Test (Sends directly to laser)</button>
        </div>
        <div id="focus-result" style="margin-top:8px; font-size:0.8rem; color:#adadb8;"></div>
    </div>

    <!-- MANUAL PLACEMENT -->
    <div class="card">
        <h3>Add Manual Placement</h3>
        <p style="font-size:0.78rem; color:#adadb8; margin-bottom:8px;">Block out a region without engraving.</p>
        <label>Name / label</label>
        <input type="text" id="mp-name" placeholder="e.g. ExistingName" maxlength="40">
        <label style="margin-top:10px;">Rectangle (machine coordinates)</label>
        <div class="coord-row">
            <div><label>X1</label><input type="number" id="mp-x1" placeholder="0" step="0.1"></div>
            <div><label>Y1</label><input type="number" id="mp-y1" placeholder="0" step="0.1"></div>
            <div><label>X2</label><input type="number" id="mp-x2" placeholder="20" step="0.1"></div>
            <div><label>Y2</label><input type="number" id="mp-y2" placeholder="8" step="0.1"></div>
        </div>
        <div class="btn-row">
            <button onclick="addManualPlacement()">&#43; Add to Database</button>
        </div>
        <div id="mp-result" style="margin-top:8px; font-size:0.8rem; color:#adadb8;"></div>
    </div>

    <!-- QUEUE / HISTORY -->
    <div class="card span-2">
        <h3>Engraving Queue & History</h3>
        <!-- Added wrapper to handle scroll independently of the list content -->
        <div id="queue-container">
            <div id="queue-list">Loading queue...</div>
        </div>
    </div>

    <!-- TEXT / FONT SETTINGS -->
    <div class="card span-2">
        <h3>Text &amp; Font Settings</h3>
        <div class="form-grid">
            <div>
                <label>Initial Height (mm)</label>
                <input type="number" id="s-height" min="2" max="50" step="0.5" value="5">
            </div>
            <div>
                <label>Min Height (mm)</label>
                <input type="number" id="s-min-height" min="1" max="20" step="0.5" value="2">
            </div>
            <div style="grid-column:1/-1">
                <label>Font</label>
                <select id="s-font"></select>
            </div>
            
            <!-- BOLDING OPTIONS -->
            <div>
                <label>Bolding / Retrace Repeats</label>
                <input type="number" id="s-bold-repeats" min="1" max="10" step="1" value="1">
                <p class="hint">1 = normal, >1 adds offset paths</p>
            </div>
            <div>
                <label>Bolding Offset (mm)</label>
                <input type="number" id="s-bold-offset" min="0.05" max="2.0" step="0.05" value="0.15">
            </div>
            <div>
                <label>Bolding Pattern</label>
                <select id="s-bold-pattern">
                    <option value="cross">Cross (+ shape)</option>
                    <option value="circle">Circular (rounded)</option>
                </select>
            </div>
            <div>
                <label>Y-Axis Text Direction</label>
                <select id="s-mirror-y">
                    <option value="false">Standard CNC (+Y is UP/AWAY)</option>
                    <option value="true">Mirrored (+Y is DOWN/TOWARD)</option>
                </select>
                <p class="hint">Flips text vertically</p>
            </div>
        </div>
        <div class="btn-row">
            <button onclick="saveTextSettings()">&#128190; Save Text Settings</button>
            <span class="save-ok" id="text-ok">&#10003; Saved</span>
        </div>
    </div>

    <!-- LASER SETTINGS -->
    <div class="card">
        <h3>Laser Settings</h3>
        <div class="form-grid">
            <div>
                <label>Power (%)</label>
                <input type="number" id="s-power" min="0" max="100" step="1" value="50">
            </div>
            <div>
                <label>Spindle Max (S)</label>
                <input type="number" id="s-spindle-max" min="100" max="10000" step="100" value="1000">
            </div>
            <div>
                <label>Speed (mm/min)</label>
                <input type="number" id="s-speed" min="100" max="10000" step="100" value="1000">
            </div>
            <div>
                <label>Passes</label>
                <input type="number" id="s-passes" min="1" max="5" step="1" value="1">
            </div>
            <div style="grid-column:1/-1">
                <label>Z Height (mm) <span style="color:#6b6b78; font-weight:normal;">&#8212; 0 = disabled</span></label>
                <input type="number" id="s-z-height" min="0" max="100" step="0.1" value="0" placeholder="0">
                <p class="hint">Raises Z to this position before engraving.</p>
            </div>
        </div>
        <div class="btn-row">
            <button onclick="saveLaserSettings()">&#128190; Save Laser Settings</button>
            <span class="save-ok" id="laser-ok">&#10003; Saved</span>
        </div>
    </div>

    <!-- OBS SETTINGS -->
    <div class="card span-2">
        <h3>&#127909; OBS WebSocket Integration</h3>
        <p style="font-size:0.78rem; color:#adadb8; margin-bottom:12px;">
            Enable WebSocket in OBS under <strong>Tools &rarr; WebSocket Server Settings</strong>.
        </p>
        <div class="form-grid">
            <div>
                <label>Enabled</label>
                <select id="obs-enabled">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            <div>
                <label>OBS Host (LAN IP)</label>
                <input type="text" id="obs-host" placeholder="192.168.1.100">
            </div>
            <div>
                <label>Port</label>
                <input type="number" id="obs-port" value="4455" min="1" max="65535">
            </div>
            <div>
                <label>Password</label>
                <input type="password" id="obs-password" placeholder="your_obs_ws_password">
            </div>
        </div>

        <div class="obs-action-group">
            <h4>&#9654; Engrave Start Actions (JSON array)</h4>
            <p class="hint" style="margin-bottom:6px;">Runs when engraving begins. Use <code>{name}</code> for sub name.</p>
            <textarea id="obs-start-actions" rows="4" placeholder='[{"type":"show_source","scene":"Live","source":"Laser"}]'></textarea>
        </div>

        <div class="obs-action-group">
            <h4>&#9646;&#9646; Engrave Finish Actions (JSON array)</h4>
            <textarea id="obs-finish-actions" rows="3" placeholder='[{"type":"hide_source","scene":"Live","source":"Laser"}]'></textarea>
        </div>

        <div class="btn-row">
            <button onclick="saveOBSSettings()">&#128190; Save OBS</button>
            <button class="secondary" onclick="reconnectOBS()">&#128279; Reconnect</button>
            <button class="secondary" onclick="testOBS('start')">&#9654; Test Start</button>
            <button class="secondary" onclick="testOBS('finish')">&#9646;&#9646; Test Finish</button>
            <span class="save-ok" id="obs-ok">&#10003; Saved</span>
        </div>
        <div id="obs-result" style="margin-top:8px; font-size:0.8rem; color:#adadb8;"></div>
    </div>

    <!-- WORK AREA -->
    <div class="card">
        <h3>Work Area</h3>
        <div class="form-grid">
            <div><label>Machine Width (mm)</label><input type="number" id="wa-mw" min="1" max="2000" step="1" value="200"></div>
            <div><label>Machine Height (mm)</label><input type="number" id="wa-mh" min="1" max="2000" step="1" value="298"></div>
            <div><label>Active Width (mm)</label><input type="number" id="wa-aw" min="1" max="2000" step="1" value="200"></div>
            <div><label>Active Height (mm)</label><input type="number" id="wa-ah" min="1" max="2000" step="1" value="298"></div>
            <div><label>Offset X (mm)</label><input type="number" id="wa-ox" min="0" max="2000" step="1" value="0"></div>
            <div><label>Offset Y (mm)</label><input type="number" id="wa-oy" min="0" max="2000" step="1" value="0"></div>
        </div>
        <div class="btn-row">
            <button onclick="saveWorkArea()">&#128190; Apply</button>
            <span class="save-ok" id="wa-ok">&#10003; Applied</span>
        </div>
    </div>

    <!-- SYSTEM CONTROLS -->
    <div class="card">
        <h3>&#9888;&#65039; System Controls</h3>
        <div class="danger-zone">
            <div class="btn-row">
                <button class="danger" onclick="resetBoard()">&#128465; Reset Board</button>
                <button class="warn"   onclick="restartService()">&#128260; Restart Service</button>
            </div>
        </div>
    </div>

    <!-- VISUALIZER -->
    <div class="card span-2">
        <h3>Layout Visualizer</h3>
        <div id="visualizer-wrap">
            <div style="position:relative;">
                <canvas id="layout-canvas" width="600" height="420"></canvas>
                <div id="canvas-tooltip"></div>
            </div>
            <div id="canvas-legend">
                <div><span class="legend-swatch" style="background:#1a1a1a; border:1px solid #555;"></span> Machine bed</div>
                <div><span class="legend-swatch" style="background:rgba(145,71,255,0.12); border:1px dashed #9147ff;"></span> Active engraving area</div>
                <div><span class="legend-swatch" style="background:rgba(0,180,100,0.45);"></span> Engraved name</div>
                <div style="margin-top:12px; color:#efeff1; font-size:0.8rem; line-height:1.9;" id="vis-info">Loading...</div>
            </div>
        </div>
    </div>

    <!-- LOG -->
    <div class="card">
        <h3>Activity Log</h3>
        <div id="log"></div>
    </div>

</div>

<script>
function log(msg, color) {
    color = color || '#adadb8';
    var el = document.getElementById('log');
    var ts = new Date().toLocaleTimeString();
    el.innerHTML += '<div style="color:' + color + '">[' + ts + '] ' + msg + '</div>';
    el.scrollTop = el.scrollHeight;
}

async function api(path, method, body) {
    method = method || 'GET';
    var opts = { method: method, headers: {'Content-Type':'application/json'} };
    if (body) opts.body = JSON.stringify(body);
    var r = await fetch(path, opts);
    return r.json();
}

// STATUS
async function updateStatus() {
    try {
        var s = await api('/api/status');
        setDot('dot-laser',  s.laser_connected);
        setDot('dot-twitch', s.twitch_running);
        setDot('dot-camera', s.camera_running);
        setDot('dot-obs',    s.obs_connected);
        document.getElementById('stat-queue').textContent    = s.queue_size;
        document.getElementById('stat-names').textContent    = s.placements;
        document.getElementById('stat-coverage').textContent = s.coverage + '%';
        document.getElementById('btn-twitch').innerHTML      = s.twitch_running ? '&#9646;&#9646; Stop Twitch' : '&#9654; Start Twitch';

        if (!window._settingsLoaded && s.config) {
            var ls  = s.config.laser_settings || {};
            var ts2 = s.config.text_settings  || {};
            setVal('s-power',      ls.power_percent    || 50);
            setVal('s-spindle-max',ls.spindle_max       || 1000);
            setVal('s-speed',      ls.speed_mm_per_min  || 1000);
            setVal('s-passes',     ls.passes            || 1);
            setVal('s-z-height',   ls.z_height_mm !== undefined ? ls.z_height_mm : (ls.z_depth_mm !== undefined ? ls.z_depth_mm : 0));
            setVal('s-height',     ts2.initial_height_mm || 5);
            setVal('s-min-height', ts2.min_height_mm     || 2);
            
            // New Bolding & Mirror settings
            setVal('s-bold-repeats', ts2.bold_repeats || 1);
            setVal('s-bold-offset',  ts2.bold_offset_mm || 0.15);
            if (ts2.bold_pattern) setVal('s-bold-pattern', ts2.bold_pattern);
            if (ts2.mirror_y !== undefined) setVal('s-mirror-y', ts2.mirror_y ? 'true' : 'false');
            
            if (ts2.font)     setVal('s-font',     ts2.font);
            window._settingsLoaded = true;
        }
    } catch(e) {}
}

function setDot(id, on) { document.getElementById(id).className = 'dot' + (on ? ' on' : ''); }
function setVal(id, v)  { var el = document.getElementById(id); if (el) el.value = v; }

// FONT DROPDOWN
async function loadFonts() {
    try {
        var fonts = await api('/api/fonts');
        var sel   = document.getElementById('s-font');
        sel.innerHTML = '';
        fonts.forEach(function(f) {
            var opt = document.createElement('option');
            opt.value = f.key; opt.textContent = f.label;
            sel.appendChild(opt);
        });
    } catch(e) {}
}

// LASER CONTROLS
async function laserCmd(action) {
    var ep = {home:'/api/laser_home', unlock:'/api/laser_unlock', stop:'/api/laser_stop'};
    var r  = await api(ep[action], 'POST');
    log(action + ': ' + (r.message || (r.success ? 'OK' : 'Failed')), r.success ? '#00c853' : '#e91916');
}
async function sendManual() {
    var cmd = document.getElementById('manual-cmd').value.trim();
    if (!cmd) return;
    var r = await api('/api/laser_command', 'POST', {command: cmd});
    log('> ' + cmd + '  ->  ' + (r.response || ''), r.success ? '#efeff1' : '#e91916');
    document.getElementById('manual-cmd').value = '';
}
async function toggleTwitch() {
    var r = await api('/api/twitch_toggle', 'POST');
    log('Twitch ' + (r.running ? 'started' : 'stopped'), r.running ? '#00c853' : '#adadb8');
}
async function reconnectLaser() {
    log('Reconnecting laser...', '#ffa000');
    var r = await api('/api/laser_reconnect', 'POST');
    log('Laser: ' + r.message, r.success ? '#00c853' : '#e91916');
}
async function reconnectTwitch() {
    log('Reconnecting Twitch...', '#ffa000');
    var r = await api('/api/twitch_reconnect', 'POST');
    log('Twitch: ' + r.message, r.success ? '#00c853' : '#e91916');
}
async function reconnectOBS() {
    log('Reconnecting OBS...', '#ffa000');
    var r = await api('/api/obs_reconnect', 'POST');
    log('OBS: ' + r.message, r.success ? '#00c853' : '#e91916');
}

// TEST ENGRAVE
async function testEngrave() {
    var text = document.getElementById('test-text').value.trim();
    if (!text) return;
    var x1=document.getElementById('te-x1').value, y1=document.getElementById('te-y1').value,
        x2=document.getElementById('te-x2').value, y2=document.getElementById('te-y2').value;
    var body = {text: text};
    
    if (x1 !== '' && y1 !== '') {
        body.rect = { x1: parseFloat(x1), y1: parseFloat(y1) };
        if (x2 !== '' && y2 !== '') {
            body.rect.x2 = parseFloat(x2);
            body.rect.y2 = parseFloat(y2);
        }
    }
        
    var r  = await api('/api/test_engrave', 'POST', body);
    var el = document.getElementById('engrave-result');
    el.textContent = r.message; el.style.color = r.success ? '#00c853' : '#e91916';
    log('Test engrave "'+text+'" queued', r.success?'#00c853':'#e91916');
}

// FOCUS TEST
async function startFocusTest() {
    if (!confirm('Warning: This will send G-Code immediately to the laser, moving from X1,Y1 to X2,Y2 and ramping the Z axis. Ensure the bed is clear. Proceed?')) {
        return;
    }
    
    var el = document.getElementById('focus-result');
    el.textContent = 'Sending...';
    el.style.color = '#ffa000';
    
    var body = {
        x1: document.getElementById('ft-x1').value,
        y1: document.getElementById('ft-y1').value,
        x2: document.getElementById('ft-x2').value,
        y2: document.getElementById('ft-y2').value,
        z_dist: document.getElementById('ft-z').value,
        ticks: document.getElementById('ft-ticks').value,
        speed: document.getElementById('ft-speed').value,
        power: document.getElementById('ft-power').value
    };
    
    // Validate inputs
    for (var key in body) {
        if (body[key] === '') {
            el.textContent = 'Error: All fields are required';
            el.style.color = '#e91916';
            return;
        }
        body[key] = parseFloat(body[key]);
    }
    
    var r = await api('/api/focus_test', 'POST', body);
    el.textContent = r.message; 
    el.style.color = r.success ? '#00c853' : '#e91916';
    log('Focus Test: ' + r.message, r.success ? '#00c853' : '#e91916');
}

// MANUAL PLACEMENT
async function addManualPlacement() {
    var name=document.getElementById('mp-name').value.trim();
    var x1=document.getElementById('mp-x1').value, y1=document.getElementById('mp-y1').value,
        x2=document.getElementById('mp-x2').value, y2=document.getElementById('mp-y2').value;
    if (!name) { alert('Please enter a name.'); return; }
    if (x1===''||y1===''||x2===''||y2==='') { alert('All four coordinates required.'); return; }
    var r = await api('/api/add_placement','POST',{name:name,
        x1:parseFloat(x1),y1:parseFloat(y1),x2:parseFloat(x2),y2:parseFloat(y2)});
    var el = document.getElementById('mp-result');
    el.textContent = r.message; el.style.color = r.success?'#00c853':'#e91916';
    log('Manual placement "'+name+'": '+r.message, r.success?'#00c853':'#e91916');
    if (r.success) {
        ['mp-name','mp-x1','mp-y1','mp-x2','mp-y2'].forEach(function(id){document.getElementById(id).value='';});
        drawVisualizer();
    }
}

// OBS SETTINGS
async function loadOBSSettings() {
    try {
        var d = await api('/api/obs_config');
        setVal('obs-enabled',  d.enabled  ? 'true' : 'false');
        setVal('obs-host',     d.host     || '');
        setVal('obs-port',     d.port     || 4455);
        setVal('obs-password', d.password || '');
        var startEl  = document.getElementById('obs-start-actions');
        var finishEl = document.getElementById('obs-finish-actions');
        if (d.engrave_start_actions)  startEl.value  = JSON.stringify(d.engrave_start_actions,  null, 2);
        if (d.engrave_finish_actions) finishEl.value = JSON.stringify(d.engrave_finish_actions, null, 2);
    } catch(e) {}
}

async function saveOBSSettings() {
    var startActions = [], finishActions = [];
    try { startActions  = JSON.parse(document.getElementById('obs-start-actions').value  || '[]'); }
    catch(e) { alert('Start Actions JSON is invalid: ' + e.message); return; }
    try { finishActions = JSON.parse(document.getElementById('obs-finish-actions').value || '[]'); }
    catch(e) { alert('Finish Actions JSON is invalid: ' + e.message); return; }

    var body = {
        enabled:  document.getElementById('obs-enabled').value === 'true',
        host:     document.getElementById('obs-host').value.trim(),
        port:     parseInt(document.getElementById('obs-port').value),
        password: document.getElementById('obs-password').value,
        engrave_start_actions:  startActions,
        engrave_finish_actions: finishActions,
    };
    var r = await api('/api/obs_config', 'POST', body);
    if (r.success) { flashOk('obs-ok'); log('OBS settings saved', '#00c853'); }
    else log('OBS save failed: ' + r.message, '#e91916');
}

async function testOBS(event) {
    var r = await api('/api/obs_test_action', 'POST', {event: event});
    var el = document.getElementById('obs-result');
    el.textContent = r.message; el.style.color = r.success ? '#00c853' : '#e91916';
    log('OBS test (' + event + '): ' + r.message, r.success ? '#00c853' : '#e91916');
}

// LASER SETTINGS
async function saveLaserSettings() {
    var body = { laser_settings: {
        power_percent:    +document.getElementById('s-power').value,
        spindle_max:      +document.getElementById('s-spindle-max').value,
        speed_mm_per_min: +document.getElementById('s-speed').value,
        passes:           +document.getElementById('s-passes').value,
        z_height_mm:      +document.getElementById('s-z-height').value
    }};
    await api('/api/config','POST',body);
    flashOk('laser-ok'); log('Laser settings saved','#00c853');
}

// TEXT / FONT SETTINGS
async function saveTextSettings() {
    var font=document.getElementById('s-font').value;
    var body = { text_settings: {
        initial_height_mm: parseFloat(document.getElementById('s-height').value),
        min_height_mm:     parseFloat(document.getElementById('s-min-height').value),
        font: font,
        bold_repeats:   parseInt(document.getElementById('s-bold-repeats').value),
        bold_offset_mm: parseFloat(document.getElementById('s-bold-offset').value),
        bold_pattern:   document.getElementById('s-bold-pattern').value,
        mirror_y:       document.getElementById('s-mirror-y').value === 'true'
    }};
    await api('/api/config','POST',body);
    flashOk('text-ok'); log('Text settings saved â€” font: '+font,'#00c853');
}

// WORK AREA
async function loadWorkArea() {
    var d = await api('/api/work_area');
    if (d.machine){setVal('wa-mw',d.machine.width_mm);setVal('wa-mh',d.machine.height_mm);}
    if (d.active) {setVal('wa-aw',d.active.width_mm); setVal('wa-ah',d.active.height_mm);
                   setVal('wa-ox',d.active.offset_x);  setVal('wa-oy',d.active.offset_y);}
    drawCanvas(d);
}
async function saveWorkArea() {
    var body={
        machine_width_mm: +document.getElementById('wa-mw').value,
        machine_height_mm:+document.getElementById('wa-mh').value,
        active_width_mm:  +document.getElementById('wa-aw').value,
        active_height_mm: +document.getElementById('wa-ah').value,
        offset_x_mm:      +document.getElementById('wa-ox').value,
        offset_y_mm:      +document.getElementById('wa-oy').value
    };
    var r=await api('/api/work_area','POST',body);
    if(r.success){flashOk('wa-ok');log('Work area applied','#00c853');drawVisualizer();}
    else log('Work area error: '+r.message,'#e91916');
}

// DANGER ZONE
async function resetBoard() {
    if(prompt('Type RESET to confirm:')!=='RESET'){log('Reset cancelled.','#adadb8');return;}
    var r=await api('/api/reset_board','POST');
    log(r.message,r.success?'#ffa000':'#e91916');
    if(r.success) drawVisualizer();
}
async function restartService() {
    if(prompt('Type RESTART to confirm:')!=='RESTART'){log('Restart cancelled.','#adadb8');return;}
    log('Restarting... reloading in 8s','#ffa000');
    await api('/api/restart_service','POST');
    setTimeout(function(){location.reload();},8000);
}

// QUEUE / HISTORY
var _lastQueueJson = '';
async function updateQueue() {
    try {
        var d = await api('/api/jobs');
        var jsonStr = JSON.stringify(d.jobs);
        if (jsonStr === _lastQueueJson) return; // Only re-render if data actually changed
        _lastQueueJson = jsonStr;

        var el = document.getElementById('queue-list');
        if (d.jobs && d.jobs.length > 0) {
            el.innerHTML = d.jobs.map(function(j) {
                var statusColor = '#adadb8';
                var statusIcon = '&#8987;'; // hourglass
                if (j.status === 'active') { statusColor = '#9147ff'; statusIcon = '&#9889;'; } // lightning
                else if (j.status === 'finished') { statusColor = '#00c853'; statusIcon = '&#10004;'; } // check
                else if (j.status === 'failed' || j.status === 'stopped') { statusColor = '#e91916'; statusIcon = '&#10060;'; } // X
                
                var timeStr = new Date(j.timestamp).toLocaleString();
                
                var actionBtns = '';
                if (j.status === 'active' || j.status === 'pending') {
                    actionBtns += `<button class="danger" onclick="jobAction('${j.id}', 'stop')" title="Stop Engraving">&#9209;</button>`; // stop square
                } else {
                    actionBtns += `<button class="secondary" onclick="jobAction('${j.id}', 'redo')" title="Redo Engrave with exact same settings">&#128259;</button>`; // refresh/redo
                }
                
                if (j.gcode_file) {
                    actionBtns += `<button class="secondary" onclick="downloadGcode('${j.id}')" title="Download G-Code">&#11015;</button>`; // down arrow
                }
                
                var settingsHtml = '';
                if (j.settings && Object.keys(j.settings).length > 0) {
                    var sText = `Font: ${j.settings.font}\\nSize: ${j.settings.width}x${j.settings.height} mm\\nPosition: (${j.settings.x_machine}, ${j.settings.y_machine})\\nPower: ${j.settings.power}%\\nSpeed: ${j.settings.speed} mm/m`;
                    if (j.settings.bold_repeats > 1) {
                         sText += `\\nBold: ${j.settings.bold_repeats}x (${j.settings.bold_offset_mm}mm)`;
                    }
                    settingsHtml = `
                        <div class="job-settings-tooltip">&#9881;
                            <span class="tooltiptext">${sText}</span>
                        </div>
                    `;
                }
                
                var errText = j.error ? `<div style="color:#e91916; font-size:0.75rem; margin-top:4px;">${j.error}</div>` : '';
                
                return `
                <div class="queue-item ${j.status}">
                    <div class="queue-icon" title="${timeStr}">${statusIcon}</div>
                    <div class="queue-details">
                        <strong style="color:${statusColor}">${j.name}</strong> 
                        <span style="color:#6b6b78;font-size:0.75rem">(${j.source})</span>
                        ${settingsHtml}
                        ${errText}
                    </div>
                    <div class="queue-actions">
                        ${actionBtns}
                    </div>
                </div>`;
            }).join('');
        } else { 
            el.textContent = 'Queue is empty'; 
        }
    } catch(e) {}
}

async function jobAction(jobId, action) {
    if (action === 'redo' && !confirm('Are you sure you want to redo this exact engrave? It will overlap if the board has not moved.')) return;
    var r = await api('/api/jobs/' + jobId + '/action', 'POST', {action: action});
    log('Job ' + action + ': ' + (r.message || 'Sent'), r.success ? '#00c853' : '#e91916');
    _lastQueueJson = ''; // force a refresh
    updateQueue();
}

function downloadGcode(jobId) {
    window.open('/api/jobs/' + jobId + '/gcode', '_blank');
}


// VISUALIZER
async function drawVisualizer(){var d=await api('/api/work_area');drawCanvas(d);}
function drawCanvas(d) {
    if(!d||!d.machine||!d.machine.width_mm) return;
    var canvas=document.getElementById('layout-canvas'),ctx=canvas.getContext('2d');
    var PAD=24,mw=d.machine.width_mm,mh=d.machine.height_mm;
    var scale=Math.min((canvas.width-PAD*2)/mw,(canvas.height-PAD*2)/mh);
    canvas._scale=scale;canvas._pad=PAD;canvas._data=d;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#1a1a1a';ctx.fillRect(PAD,PAD,mw*scale,mh*scale);
    ctx.strokeStyle='#555';ctx.lineWidth=1;ctx.strokeRect(PAD,PAD,mw*scale,mh*scale);
    ctx.strokeStyle='#252525';ctx.lineWidth=0.5;
    for(var gx=50;gx<mw;gx+=50){var gpx=PAD+gx*scale;ctx.beginPath();ctx.moveTo(gpx,PAD);ctx.lineTo(gpx,PAD+mh*scale);ctx.stroke();}
    for(var gy=50;gy<mh;gy+=50){var gpy=PAD+gy*scale;ctx.beginPath();ctx.moveTo(PAD,gpy);ctx.lineTo(PAD+mw*scale,gpy);ctx.stroke();}
    if(d.active&&d.active.width_mm){
        var ax=PAD+d.active.offset_x*scale,ay=PAD+d.active.offset_y*scale;
        var aw=d.active.width_mm*scale,ah=d.active.height_mm*scale;
        ctx.fillStyle='rgba(145,71,255,0.07)';ctx.fillRect(ax,ay,aw,ah);
        ctx.strokeStyle='#9147ff';ctx.lineWidth=1.5;
        ctx.setLineDash([7,3]);ctx.strokeRect(ax,ay,aw,ah);ctx.setLineDash([]);
        ctx.fillStyle='#9147ff';ctx.font='10px sans-serif';
        ctx.fillText('Active '+d.active.width_mm+'x'+d.active.height_mm+'mm  offset ('+d.active.offset_x+','+d.active.offset_y+')',ax+4,ay+13);
    }
    var ox=d.active?d.active.offset_x:0,oy=d.active?d.active.offset_y:0;
    (d.placements||[]).forEach(function(p){
        var px=PAD+(p.abs_x!==undefined?p.abs_x:p.x+ox)*scale;
        var py=PAD+(p.abs_y!==undefined?p.abs_y:p.y+oy)*scale;
        var pw=p.width*scale,ph=p.height*scale;
        ctx.fillStyle='rgba(0,180,100,0.35)';ctx.fillRect(px,py,pw,ph);
        ctx.strokeStyle='#00b464';ctx.lineWidth=0.8;ctx.strokeRect(px,py,pw,ph);
        if(pw>18){ctx.fillStyle='#efeff1';ctx.font=Math.min(9,ph*0.7)+'px sans-serif';
            ctx.save();ctx.beginPath();ctx.rect(px,py,pw,ph);ctx.clip();
            ctx.fillText(p.name,px+2,py+ph*0.72);ctx.restore();}
    });
    ctx.fillStyle='#ffa000';ctx.beginPath();ctx.arc(PAD,PAD,4,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ffa000';ctx.font='9px sans-serif';ctx.fillText('0,0',PAD+6,PAD+4);
    ctx.fillStyle='#555';ctx.font='8px sans-serif';
    ctx.fillText(mw+'mm',PAD+mw*scale-22,PAD+mh*scale+14);
    ctx.fillText(mh+'mm',2,PAD+mh*scale);
    var pl=(d.placements||[]).length;
    document.getElementById('vis-info').innerHTML=
        '<b>'+pl+'</b> name'+(pl!==1?'s':'')+' engraved<br>'+
        'Machine: '+mw+'x'+mh+'mm<br>'+'Active: '+(d.active?d.active.width_mm:mw)+'x'+(d.active?d.active.height_mm:mh)+'mm<br>'+
        'Offset: ('+(d.active?d.active.offset_x:0)+', '+(d.active?d.active.offset_y:0)+')mm';
}
document.getElementById('layout-canvas').addEventListener('mousemove',function(e){
    var d=this._data;if(!d||!d.placements)return;
    var rect=this.getBoundingClientRect(),mx=e.clientX-rect.left,my=e.clientY-rect.top;
    var scale=this._scale,pad=this._pad,ox=d.active?d.active.offset_x:0,oy=d.active?d.active.offset_y:0;
    var tip=document.getElementById('canvas-tooltip'),found=null;
    (d.placements||[]).forEach(function(p){
        var px=pad+(p.abs_x!==undefined?p.abs_x:p.x+ox)*scale;
        var py=pad+(p.abs_y!==undefined?p.abs_y:p.y+oy)*scale;
        if(mx>=px&&mx<=px+p.width*scale&&my>=py&&my<=py+p.height*scale)found=p;
    });
    if(found){tip.style.display='block';tip.style.left=(mx+14)+'px';tip.style.top=(my-8)+'px';
        tip.textContent=found.name+'  '+found.width.toFixed(1)+'x'+found.height.toFixed(1)+'mm  h='+found.text_height_mm.toFixed(1)+'mm';}
    else tip.style.display='none';
});
document.getElementById('layout-canvas').addEventListener('mouseleave',function(){document.getElementById('canvas-tooltip').style.display='none';});

function flashOk(id){var el=document.getElementById(id);el.style.display='inline';setTimeout(function(){el.style.display='none';},3000);}

window.addEventListener('DOMContentLoaded',async function(){
    log('TwitchLaser UI loaded','#9147ff');
    await loadFonts();
    await loadWorkArea();
    await loadOBSSettings();
    await updateStatus();
    await updateQueue();
    setInterval(updateStatus,3000);
    setInterval(updateQueue,2000); // Updated to poll history more frequently, safe since JSON check prevents rewrite
    setInterval(drawVisualizer,12000);
});
</script>
</body>
</html>